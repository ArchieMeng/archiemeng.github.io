---
title: "一个开发视角下的Deepin23"
description: 
date: 2024-09-08T10:56:21+08:00
lastMod: 2024-11-15T21:17:45+08:00
image: 
math: 
license: 
hidden: false
comments: false
isCJKLanguage: true
draft: false
---

上个月，开发历时近三年，万众瞩目的deepin 23终于正式发布了。作为deepin 23的开发和见证者，也是**有很多想要写的感想。（棒读）**

**Update**: 实际发出来，已经正好是三个月以前了。

那么，事不宜迟，就让我用时间顺序来写下我在deepin 23中开发的种种经历。

## 初次接触到的deepin 23项目竟然是......

时间回到2022年7月，此时的笔者刚结束了为了赶毕业设计而请的长假。回到单位却发现自己工位上坐着别人。正当我懵逼的时候，此时的部长过来告诉我，我被调去做新应用了，名字是升级工具。没错，就是你们现在在用的V20升级V23的升级工具。也正是这个时候，我才知道了deepin 23系统的存在，以及系统架构变化大到，不得不专门开发一款系统升级工具的事情。

这里介绍一下升级工具。实际上，大家现在所看到的升级工具，只不过是个不到当初计划内容二分之一的产品。为什么呢？这就不得不提升级工具和deepin 23系统当时的项目进度规划。如果我没记错的话，deepin 23原定于2023年2-3月左右的发布。为配合发布，升级工具便原定2023年1-2月发布。然而，想法是美好的，但意外总会出现。不出意外，就出了意外。记不清是什么缘故，忽然deepin 23系统的发布被提前了两个月，为此，升级工具也不得不相应地要提前了两个月完成。为了提前完成，整个项目砍掉了很多功能，比如应用设置界面（没错，升级工具其实是有配置，但需要用户手动修改应用配置文本），自动更新系统，自动下发配置，离线应用安装的功能以及一些其他的升级场景。

最后的结果便是，由于工期的急剧缩短，外加中途人员变动和疫情封控影响，整个项目的进度和质量都受到了极大程度地影响，也就成了现在那样子了。就算项目初步完成了，不仅deepin 23没正式发布，这个工具也没有继续实现原计划中的功能，甚至没有进一步优化。

我也不知道该说什么好。作为我进公司完成的第一个应用研发项目，要说没一点感情是不太可能的。我本来就对这项目是比较看好的，甚至当带我的研发说它是只用来升级23的临时工具时，和他杠上了......事后也证明，我的判断是准确的。尽管它很矬，但还是被用到了其他的一些系统升级场景中。或许还是，谋事在人，成事在天，事在人为。

## 加入deepin开源社区

2023年初的时候，我记得就传出开源中心要人手的消息。然后，就看到zccrs跑到我们部门要人。部长自然是把我推荐了过去。起初我还很犹豫，因为在商言商地说，搞开源对于公司，确实是一个能提升企业形象，但没有实际营收的工作。除此之外，国内做开源社区工作的话，职业路线就不太明确了。大概是看到我犹豫，部长都拉我谈话，做我工作了。这个时候，我才知道开源社区是老板想做的，deepin并没有忘记最初的使命，甚至加入开源社区那边，在公司里是受羡慕的。好吧，那就去吧。就这样，我加入了那边。

## Dogfooding

根据我最开始提交的意向表，我被分配到了系统组，同时负责deepin-terminal的开发和维护工作。实际上，尽管我在搞升级工具的时候就见到了deepin 23版本的实际系统，但那时候项目只关心升级上去以及基本使用，不会在23上用得太多。所以，我还是一直用着deepin 20系统。虽然zccrs一直在催我们用23系统，但当时系统的完成度确实难以恭维：缺包的缺包，Bug满天飞，根本没法日常使用。因此，我当时一直是用的虚拟机调Bug,装包测试的。（反正玩炸了还能回滚，哈哈哈）

直到有一次绩效谈话，我提到我的办公环境很吵，很影响我的工作效率。最后在远程办公和坐班之间，选择了让我配一台笔记本的折中方案。此时，我也决定亲自用上23来办公开发系统。毕竟是一个全新的环境，我可以放开装deepin 23来弄嘛。

最后看来，zccrs的提议很正确。只有亲身体验并完善系统，才能真正地搞好它。这期间，虽然又是桌面崩溃，又是什么任务栏乱飞，缺包依赖爆炸啥都装不上之类的。记得最清楚的一次，我拿CI源滚包把桌面给滚炸了，进不了桌面，气得我一路找窗管，AM(Application Manager)，最终找到DDE组催促他们修好。后面也有好几次这样的事情，不过好在都找到了对应的组去协商解决。

## 大型ARM开发板刷机现场

大概是去年5月时，zccrs忽然找我说，你想不想搞mac silicon上的deepin移植？我看还有这种有意思的事情？我还求之不得呢。然后，我才发现什么天坑。

尽管Asahi Linux这个项目有提供一整套完整的工具链和方案，但你还是得要理解Mac设备上那套奇特的引导系统，以及在此之上启动Linux的整个流程。虽然有m1-debian这个基于Asahi Linux的非官方项目作为工作基础和参考，但打刷机包（毕竟主要安装过程就是刷机）和Mac专用的系统包是要自己根据deepin系统进行适配的。你不知道，我当时和Zeno调了多久内核。它的内核还必须得用Rust打包啊！！！各种网络卡，Rust装不上拖时间。装好了之后，又得看内核config有没有写对。

好在努力没有白费，最终还是在一个周五点亮了Mac。在屏幕上用neofetch打出deepin logo,凯旋回家过了个愉快的周末！要我说，这真的给我了久违的，大二时候给树莓派刷上各种操作系统，然后成功点亮的快乐。

![20230526_183010](assets/20230526_183010.JPG)

然后，适配完了基本系统环境，便可以开始挑战启动大家常见到的桌面环境了。调这个的时候没少去找竹子，rewine等人问这问那。也是在这个从基础rootfs环境中安装配置DDE桌面的过程中，我基本了解了DDE桌面的架构。当然，最后还是起了起来。虽然问题比较多，(比如，桌面环境莫名其妙依赖libssl-dev, 必须得装它，否则起不了桌面。)但又不是不能用。哈哈。随后，便是不停地尝试内核编译，mesa编译等。其中，便有开启了GPU硬件加速支持的内容。虽然我说得好像很轻松似的，但当时真的调了很久，要编译内核然后装上去看效果，调得很死去活来。好在，最后都成功了。



## 组织决定了，就由你来修安装器

事情的背景大概是安装器原本是由专业版的人来修的，结果他们自己的事情都忙不过来，导致没空去管我们提的Bug和需求。于是，组织决定了，由我们自己来处理。然后，zccrs就找上了我来。我也很乐意接手这玩意，毕竟可以更深入地了解我们的系统是如何装起来的。

结果，一上手才发现，它的代码真的是一坨。真的比deepin-terminal被魔改的部分还一坨。。。不过，正是因为它还有很多缺陷和设计实现欠妥的地方，所以才有改进的必要。回顾接手安装器维护之后所做的工作，真的干了不少。一方面是改掉原先不知为啥加上的奇怪要求，比如，所有复用的已有分区都必须得格式化，启动分区必须得是设备的第一个分区啥的；另一方面，是加上社区版需要的功能，比如安装时切tty自动登陆一个用户来进行系统操作，单独的试用模式。

不过，这个试用模式，回想当时做他的经历，就不得不拿出来吐槽吐槽。本来我以为这是一项很简单的工作，大概只需要我改个什么配置，扑通一下，就好了。当我一上手的时候，我就意识到我Too young Too simple了。首先，按理来说，我们的专业版（商用版本deepin）本来就有这个功能，我只需要和这个版本保持一致，即GRUB启动参数去掉live-installer参数即可。然而，我都没想到的是，原来社区版本的这个参数支持有问题！试用用户，工作区等等配置都没有正确实现。怪不得之前被屏蔽掉了。于是，我便一边咨询专业版的相关开发，一边自己一遍遍地尝试开启这个功能。大概花一周的时间，我给这个功能调通了。我此时还有点小激动。不过我还不知道的是，这还只是这个功能开发的开始。

随后的测试，便暴露出了它没有自动登陆的功能。这个原因现在说起来也挺复杂的。首先，这个功能在V23上是lightdm提供的。甚至，开启自动登录并不需要直接修改lightdm的配置，提供试用模式功能的live-config组件会在正确配置LIVE_CONFIG_USER_AUTOLOGIN（具体请参考live-config文档，我记不太清了）的情况下，自己去修改相应DM的配置。而问题便出现在了lightdm最后的试用模式配置中去。最开始的时候，我还没有怀疑到这个上面去。我按照正常逻辑，看到我们的控制中心（桌面系统设置）中，有配置用户自动登录和无密码登陆的选项。于是，便顺着这个方向去找了桌面环境，专业版负责用户登陆的人。无果。后来排查lightdm的日志，在窗管开发的提醒之下，注意到了我以为不是什么大问题的Log.因为这条Log只是说明镜像中lightdm配置的user-session不对，所以我自然而然地给忽略掉了。（事实证明，Debug的时候，可不能放过任何一条可疑的Log）依照他的建议，我排查了当前deepin 23的user-session以及配置的user-session,果然对不上：当前23使用的是dde-x11,而配置中使用的是deepin.后来我才了解到，这是个历史遗留问题，变更的过程中，没能及时改掉这里。而我所能办到的事情很有限。因为这个配置实际上是不知道被谁修改成这样的。(/etc/lightdm/lightdm.conf)，而我暂时又没有能力去排查去调查是谁改的。（虽然后来知道可以用audit。）于是乎，只能退而求其次，暂时采用由安装器deepin-installer进live模式桌面之前再进行一次配置修改。在工程能力范围内无法解决之时，不得不妥协，采用临时的解决方案是一件很常见且对结果负责的做法。可惜的是，它不太适合在苛刻的社区环境中使用，因为就连我都知道，这个做法比较脏。试用模式刚推出的时候，就被某个暴躁老哥在论坛发帖喷了。（这个老哥之前就是在做deepin LiveCD项目的。）我只能表示，非常抱歉，我也有我很无奈的地方。

除此之外，海外用户的吐槽也是十分炸裂的。这也是一个我们事先未曾想到的地方。那便是，我们默认进去是中文！！！我们的试用模式硬是让老外看着中文摸索到语言设置界面去改语言。直接给那个海外评测主编干沉默了，并打出一星差评。虽然我们是一个立足中国的发行版，但海外用户也还是需要关注的。于是乎，语言，键盘布局和时区配置也提上了日程，并最终，做了出来。

到23正式发布之时，尽管我不能说解决了安装器的大部分问题，但还是进行了相当程度的改进了吧。至少问心无愧。

## 步子大了容易扯着蛋

优哉游哉地工作到了接近发布版本前的一个月，忽然接到了需要帮dde-shell组修bug的要求。直到这时，我才第一次切身意识到deepin23项目的灾难程度。是的，尽管之前我就有在亲身使用deepin23进行开发维护工作，但也只是知道有一些问题。这一次，我不得不用灾难来形容，以表达我当时的震撼程度。

从头重新开发一个全新的，美观易用的东西替换一个设计过时，臃肿的遗产项目是一件明智，且被大家都支持的事情。当然，前提是我们真的做了充足的准备去完成这件事。而dde-shell项目似乎有点不太满足这条件。它似乎很早就开始了替换原有的dde-dock+dde-launcher的进程，不过，在我们开始修Bug的时候，它就好像是一个刚开始没多久的半成品，充满着各种奇怪的，或者是恶性的Bug, 不是太让人有用下去的想法。

而我们修bug工作的评价，却只是冷冰冰的数字指标：200个bug, 需要修到只剩下80个。我很怀疑到底有没有几个是真的使用用户提的，基本的都是测试或者设计提的；同时，我也很怀疑做决定的人有没有亲自看过这200个bug或是真的自己亲手使用过一会自己的产品，因为我看到的bug报告大多数是一些像素偏移，大小不对，触发条件较难的小bug,却标着严重/立即，摁着我们的头让我们修，而真正让用户骂娘的严重问题，被裹挟淹没在其中。而为了完成指标，大家一定会去修那些容易解决的，细枝末节的小问题。除非有上面给压力，不然，真正严重难啃的问题大家会避之而不及的。同时，在测试那一边，估计也会是一样的场景：疲于验证一个又一个的bug修复，而没有空暇去关注问题的发散场景，以及可能受影响的其他部分。

## 尾声：丑媳妇也要见公婆

最后的最后，8月15日如期而至。而它带着一大堆新特性，以及，未曾设想的古怪Bug和用户见面了。甚至，Boss刘总都专门发文叙述做deepin的点点滴滴，以及deepin 23是如何问世的。尽管大家都知道它仍带着许多问题，为了带上这些年出现的新特性而不得不承担出现新问题的风险，但回想起我刚上手时候那惨不忍睹的状况，现在其实已经算是挺好的了。就让deepin 23成为22-24年工作的成果，大家放手去构建下一个deepin版本吧！
